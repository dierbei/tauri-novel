name: Android build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# å…è®¸ GITHUB_TOKEN æœ‰æƒé™åˆ›å»º Release
permissions:
  contents: write

jobs:
  android_build:
    runs-on: ubuntu-latest

    steps:
      # æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # ç”Ÿæˆç®€çŸ­æäº¤å“ˆå¸Œï¼Œä¾›æ„å»ºäº§ç‰©å‘½åä½¿ç”¨
      - name: Set short git SHA
        run: echo "SHORT_SHA=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_ENV

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # å®‰è£…å‰ç«¯ä¾èµ–ï¼ˆä¾‹å¦‚ Viteï¼‰
      - name: Install frontend dependencies
        run: npm install

      # æ„å»ºå‰ç«¯èµ„æºï¼ˆTauri ä¼šç”¨åˆ°ï¼‰
      - name: Build frontend (Vite)
        run: npm run build

      # è®¾ç½® Rust å·¥å…·é“¾å¹¶æ·»åŠ  Android æ¶æ„ç›®æ ‡
      - name: Setup Rust and Android targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      # ç¼“å­˜ Rust ç¼–è¯‘äº§ç‰©å’Œä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º
      - name: Cache Rust build
        id: cache-rust
        uses: actions/cache@v3
        with:
          path: |
            target
            ~/.cargo/registry
            ~/.cargo/git
          key: rust-cache-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            rust-cache-${{ runner.os }}-

      # æ‰“å°ç¼“å­˜å‘½ä¸­æƒ…å†µ
      - name: Check Rust cache hit
        run: |
          if [ "${{ steps.cache-rust.outputs.cache-hit }}" = "true" ]; then
            echo "âœ… Rust cache HIT â€” è·³è¿‡ä¾èµ–ç¼–è¯‘"
          else
            echo "âŒ Rust cache MISS â€” é‡æ–°ç¼–è¯‘ä¾èµ–"
          fi

      # å®‰è£… Linux ç¯å¢ƒä¾èµ–ï¼ˆGTK, WebKitï¼‰
      - name: Install Linux dependencies for Tauri
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev webkit2gtk-4.1

      # å®‰è£… Javaï¼ˆç”¨äº Android æ„å»ºï¼‰
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # å®‰è£… Android SDKã€NDK å’Œ CMake
      - name: Set up Android NDK
        uses: android-actions/setup-android@v3
        with:
          ndk-version: '25.2.9519653'
          cmake-version: '3.22.1'

      # é…ç½® ANDROID_HOME å’Œ NDK_HOME ç¯å¢ƒå˜é‡
      - name: Configure environment
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_NDK_ROOT" >> $GITHUB_PATH
          ls -la $ANDROID_NDK_ROOT

      # åˆå§‹åŒ– Tauri çš„ Android é¡¹ç›®ç»“æ„
      - name: Initialize Android target for Tauri
        run: |
          npm run tauri android init
          npm run tauri icon public/logo.png
      
      - name: Patch MainActivity.kt
        run: bash ./scripts/patch-mainactivity.sh

      # æ„å»ºæœªç­¾å APKï¼Œä»…æ„å»º arm64 æ¶æ„
      - name: Build unsigned Android APK with Tauri
        run: npm run tauri android build -- --target aarch64

      # è§£ç  keystore æ–‡ä»¶ï¼ˆå·² base64 ç¼–ç å¹¶å­˜å‚¨ä¸º Secretï¼‰
      - name: Decode keystore from base64
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE_BASE64 }}" | base64 -d > my-release-key.jks

      # ä½¿ç”¨ apksigner ç­¾å APKï¼ˆè‡ªåŠ¨è·å–æœ€æ–° build-tools è·¯å¾„ï¼‰
      - name: Sign APK
        run: |
          BUILD_TOOLS_VERSION=$(ls $ANDROID_HOME/build-tools | sort -V | tail -n1)
          $ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner sign \
            --ks my-release-key.jks \
            --ks-key-alias ${{ secrets.SIGNING_KEY_ALIAS }} \
            --ks-pass pass:${{ secrets.SIGNING_KEYSTORE_PASSWORD }} \
            --key-pass pass:${{ secrets.SIGNING_KEY_ALIAS_PASSWORD }} \
            --out app-universal-release-signed.apk \
            src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release-unsigned.apk

      # # ä¸Šä¼ ç­¾ååçš„ APK åˆ° GitHub Releaseï¼Œæ–¹ä¾¿æ‰‹æœºä¸‹è½½
      # - name: Upload signed APK to GitHub Release
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: apk-release
      #     name: APK Release ${{ env.SHORT_SHA }}
      #     files: app-universal-release-signed.apk
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Rename APK file
        run: |
          mv app-universal-release-signed.apk "ikan-novel-0.1.0.apk"
      
      - name: Upload APK Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: apk-release
          name: "çˆ±çœ‹å°è¯´ - æœ€æ–°ç‰ˆæœ¬"
          body: "ğŸ‰ çˆ±çœ‹å°è¯´ æœ€æ–°ç‰ˆæœ¬å‘å¸ƒï¼ä¸‹è½½ APK æ–‡ä»¶å³å¯å®‰è£…ä½¿ç”¨ã€‚"
          files: ikan-novel-0.1.0.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}